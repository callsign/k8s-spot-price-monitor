box: python:3-alpine
build:
  steps:
    - pip-install
    - script:
        name: Copy entrypoint
        code: cp docker-entrypoint.py /
    - internal/docker-push:
        aws-access-key: $AWS_ACCESS_KEY_ID
        aws-secret-key: $AWS_SECRET_ACCESS_KEY
        aws-region: us-east-1
        aws-registry-id: $AWS_REGISTRY_ID
        repository: pusher/spot-price-monitor
        tag: $WERCKER_GIT_COMMIT, $WERCKER_GIT_BRANCH, latest
        entrypoint: python
        cmd: -u /docker-entrypoint.py
deploy-to-kubernetes:
  steps:
    - kubectl:
        server: $KUBERNETES_MASTER
        token: $KUBERNETES_TOKEN
        insecure-skip-tls-verify: true
        command: set image -n kube-system daemonset spot-price-monitor spot-price-monitor=112622444253.dkr.ecr.us-east-1.amazonaws.com/pusher/spot-price-monitor:$WERCKER_GIT_COMMIT
